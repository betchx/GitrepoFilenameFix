GitrepoFilenameFix
==================
                                                                  2014/2/28 田辺



msysGitでレポジトリ内部へSJISで保存されてしまったファイル名を修正する．


!!!!!!!!!  注意  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
作業は空のフォルダに .git フォルダをコピーしてから作業してください．
そうしないとgitで管理していないファイルがすべてsaveフォルダ内移動され，
あたかも消去されてしまったかの様になってしまいます．
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

前提
----

1. Ruby が必要．git bashから実行できる様にパスを通しておく．
2. 全コミットのファイルがバックアップされる為，十分なディスクの空が必要．


使い方
------

1. 空のフォルダを用意
2. 修正対象の.gitフォルダ（隠し）を1.のフォルダにコピー
3. git bash を開く
4. git reset --hard でちゃんとファイルが復元されることを確認する
5. ruby UTF-rebase.rb



問題
----

古いバージョンのmsysGitではファイル名をbinaryで扱っていたため，
Windowsのファイル名はSJIS(正確にはcp932)がそのまま使用されていた．
(～AのAPIを使っていた様なので，UTF-16でもない）
ただ，ダメ文字（表やソなど）でエラーになる以外は，
msysGit単体であればそのまま日本語ファイル名を使用できていた．

ところが，Ver1.7.10でファイル名がUTF-8化し，
日本語のファイル名を適切に扱える様になった．
そのことは良かったが，環境限定ではあるが扱えていたSJISのファイル名が
新バージョンでは化けることになってしまった．
さらに，ファイル名の文字化けの修正は適切にコミットできないケースが多発した．


対処
----
Gitでは管理されるファイルはSHA1でハッシュ化されたファイル名で保存され，
ファイル名との紐付けはコミットオブジェクトでなされる．
したがって，コミット情報内部のファイル名をSJISからUTF-8に修正すればよい．
しかし，コミットオブジェクト自体もSHA1でハッシュ化された名前のファイルに保存される為，
単純に中を書き換えるとデータベースの整合性が取れなくなり後々問題となる．
そこで，正しいファイル名を用いながらrebaseする方法で対処することとした．
リベースの際に，日本語を用いたファイルがあれば正しい名前にしてから，
コミットすることで，ファイル名を適切なものに修正できる．

方法
----

リベース作業は新バージョンで行うこととなるが，
リベース中はファイル名が化けた状態でチェックアウトされてしまうので，
正しいファイル名に修正する必要がある．
しかし，ファイル名が文字化けしてしまう関係で，そのファイルへのアクセス自体が難しく，
リネーム自体が困難である．
そのため，リネームではなく，別のアプローチを用いる．

具体的な手順は以下の通り．
1. リベースでeditの状態となる．
2. .git以外のファイル・フォルダをsave/{番号}-{ハッシュ} サブフォルダ内に移動．
   (正確には，mv * save/○○/ としているだけなので，隠しフォルダ等は移動されない．注意．)
3. リセットして，ステージ情報をクリア．
4. 現在のコミットに対応するコミット情報を.gitフォルダ内から取得する．
5. コミット情報より， ファイル名とSHA1 （db内のファイル名）を取得．
6. 現コミットのファイルをdbから全て抽出し，適切なファイル名で保存する．
7. 今のファイルを追加し，修正コミット  (git commit --amend)
8. リベースを続ける．(git rebase --continue)
